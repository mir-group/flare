

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installation of FLARE &mdash; flare 1.4.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=02f2166e"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compile LAMMPS with FLARE" href="lammps.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            flare
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="installation.html">Installation</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Installation of FLARE</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#developer-s-installation-guide">Developer’s installation guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-flare-installation">Test FLARE installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#trouble-shooting">Trouble shooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acceleration-with-multiprocessing-and-mkl">Acceleration with multiprocessing and MKL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sparse-gaussian-process-model">Sparse Gaussian Process model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#full-gaussian-process-model">Full Gaussian Process model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lammps.html">Compile LAMMPS with FLARE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flare/flare.html">Python Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flare_pp/flare_pp.html">C++ Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../related.html">Applications/Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/contribute.html">How To Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">How to Cite</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">flare</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="installation.html">Installation</a></li>
      <li class="breadcrumb-item active">Installation of FLARE</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/installation/install.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installation-of-flare">
<h1>Installation of FLARE<a class="headerlink" href="#installation-of-flare" title="Link to this heading"></a></h1>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Create a new conda environment to install flare</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>flare<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.8
conda<span class="w"> </span>activate<span class="w"> </span>flare
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Use conda to install compilers and dependencies for flare</p></li>
</ol>
<ul class="simple">
<li><p>Option 1: You can load modules if your machine have already installed them (with mkl)</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>cmake/3.17.3<span class="w"> </span>gcc/9.3.0<span class="w"> </span>intel-mkl/2017.2.174
</pre></div>
</div>
<ul class="simple">
<li><p>Option 2: If you want to install flare with mkl</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>gcc<span class="w"> </span>gxx<span class="w"> </span>cmake<span class="w"> </span>mkl-devel<span class="w"> </span>mkl-service<span class="w"> </span>mkl_fft<span class="w"> </span>openmp<span class="w"> </span>-c<span class="w"> </span>conda-forge
</pre></div>
</div>
<ul class="simple">
<li><p>Option 3: If you want to install flare with openblas + lapacke</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>gcc<span class="w"> </span>gxx<span class="w"> </span>cmake<span class="w"> </span>openmp<span class="w"> </span>liblapacke<span class="w"> </span>openblas<span class="w"> </span>-c<span class="w"> </span>conda-forge
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Download flare code from github repo and pip install</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>development<span class="w"> </span>https://github.com/mir-group/flare.git
<span class="nb">cd</span><span class="w"> </span>flare
pip<span class="w"> </span>install<span class="w"> </span>.
</pre></div>
</div>
</section>
<section id="developer-s-installation-guide">
<h2>Developer’s installation guide<a class="headerlink" href="#developer-s-installation-guide" title="Link to this heading"></a></h2>
<p>After loading modules as above, we use <code class="docutils literal notranslate"><span class="pre">cmake</span></code> to compile the c++ code</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:mir-group/flare.git
<span class="nb">cd</span><span class="w"> </span>flare
mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
cmake<span class="w"> </span>..
make<span class="w"> </span>-j
</pre></div>
</div>
<p>Then copy the c-library file into the python code folder to make it importable through python</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>_C_flare*.so<span class="w"> </span>../flare/bffs/sgp
<span class="nb">cd</span><span class="w"> </span>..
</pre></div>
</div>
<p>Finally, add the path of <code class="docutils literal notranslate"><span class="pre">flare</span></code> to <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code>, such that you can <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">flare</span></code> in python.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PYTHONPATH</span><span class="si">}</span>:&lt;current_dir&gt;
</pre></div>
</div>
<p>An alternative way is setting <code class="docutils literal notranslate"><span class="pre">sys.path.append(&lt;flare</span> <span class="pre">path&gt;)</span></code> in your python script.</p>
</section>
<section id="test-flare-installation">
<h2>Test FLARE installation<a class="headerlink" href="#test-flare-installation" title="Link to this heading"></a></h2>
<p>After the installation is done, you can leave the current folder and in the python console, try</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span><span class="w"> </span><span class="nn">flare</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">flare</span><span class="o">.</span><span class="vm">__file__</span>
<span class="s1">&#39;/xxx/.conda/envs/flare/lib/python3.8/site-packages/flare/__init__.py&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span><span class="w"> </span><span class="nn">flare.bffs.sgp</span>
</pre></div>
</div>
<p>You can also check that the flare C++ library is linked to mkl (or openblas and lapacke) and openmp by</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ldd<span class="w"> </span>/xxx/.conda/envs/flare/lib/python3.8/site-packages/flare/bffs/sgp/_C_flare.*.so
</pre></div>
</div>
<p>where it is expected to show libmkl (or libopenblas), libgomp etc.</p>
</section>
<section id="trouble-shooting">
<h2>Trouble shooting<a class="headerlink" href="#trouble-shooting" title="Link to this heading"></a></h2>
<ul>
<li><p>If it fails to build mir-flare during pip install, check whether you have done <cite>conda install cxx-compiler</cite>, then it sometimes does not find the correct g++, i.e. <cite>which gcc</cite> gives the conda’s gcc, while <cite>which g++</cite> still gives the local one. In such case, try <cite>conda uninstall cxx-compiler gxx</cite>, and then redo <cite>conda install gxx -c conda-forge</cite></p></li>
<li><p>If you get the error that <cite>mkl.h</cite> is not found during pip install, first check <cite>conda list</cite> that <cite>mkl-include</cite> is installed in the current environment. You can also use your own mkl headers by setting environment variable <cite>MKL_INCLUDE</cite> to the directory</p></li>
<li><p>If you manage to install flare, but get warning when <cite>import flare.bffs.sgp</cite>, then please check</p>
<blockquote>
<div><ul class="simple">
<li><p><cite>which pip</cite> should show that <cite>pip</cite> is in the <cite>.conda/envs/flare/bin/</cite> directory, instead of others</p></li>
<li><p>the <cite>ldd</cite> command above should show the linked libraries in the <cite>.conda/envs/flare</cite> directory</p></li>
</ul>
</div></blockquote>
</li>
<li><p>If you encounter <cite>Intel MKL FATAL ERROR</cite> when running flare (after the compilation has done), this is likely a static library linkage issue. You can set up the environmental variable</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">LD_PRELOAD</span><span class="o">=</span><span class="si">${</span><span class="nv">CONDA_PREFIX</span><span class="si">}</span>/lib/libmkl_core.so:<span class="si">${</span><span class="nv">CONDA_PREFIX</span><span class="si">}</span>/lib/libmkl_intel_thread.so:<span class="si">${</span><span class="nv">CONDA_PREFIX</span><span class="si">}</span>/lib/libiomp5.so
</pre></div>
</div>
<p>as instructed in <a class="reference external" href="https://community.intel.com/t5/Intel-oneAPI-Math-Kernel-Library/mkl-fails-to-load/m-p/1155538">this discussion</a>.</p>
</section>
<section id="acceleration-with-multiprocessing-and-mkl">
<h2>Acceleration with multiprocessing and MKL<a class="headerlink" href="#acceleration-with-multiprocessing-and-mkl" title="Link to this heading"></a></h2>
<section id="sparse-gaussian-process-model">
<h3>Sparse Gaussian Process model<a class="headerlink" href="#sparse-gaussian-process-model" title="Link to this heading"></a></h3>
<p>We use OpenMP for parallelization, so please set</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span>&lt;number<span class="w"> </span>of<span class="w"> </span>CPUs<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>node&gt;
</pre></div>
</div>
<p>such that the model parallelized into <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> threads.</p>
</section>
<section id="full-gaussian-process-model">
<h3>Full Gaussian Process model<a class="headerlink" href="#full-gaussian-process-model" title="Link to this heading"></a></h3>
<p>If users have access to high-performance computers, we recommend
<a class="reference external" href="https://docs.python.org/2/library/multiprocessing.html">Multiprocessing</a> and <a class="reference external" href="https://software.intel.com/en-us/mkl">MKL</a> library set up to accelerate the training and prediction.
The acceleration can be significant when the GP training data is large.
This can be done in the following steps.</p>
<p>First, make sure the <a href="#id1"><span class="problematic" id="id2">Numpy_</span></a> library is linked with <a class="reference external" href="https://software.intel.com/en-us/mkl">MKL</a> or <a class="reference external" href="https://www.openblas.net/">Openblas</a> and <a class="reference external" href="http://www.netlib.org/lapack/">Lapack</a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import numpy as np; print(np.__config__.show())&quot;</span>
</pre></div>
</div>
<p>If no libraries are linked, <a href="#id3"><span class="problematic" id="id4">Numpy_</span></a> should be reinstalled. Detailed steps can be found in Conda <a class="reference external" href="https://docs.anaconda.com/mkl-optimizations/">manual</a>.</p>
<p>Second, in the initialization of the GP class and OTF class, turn on the GP parallelizatition and turn off the OTF par.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gp_model</span> <span class="o">=</span> <span class="n">GaussianProcess</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">per_atom_par</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_cpus</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">otf_instance</span> <span class="o">=</span> <span class="n">OTF</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">n_cpus</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Third, set the number of threads for MKL before running your python script.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">2</span>
python<span class="w"> </span>training.py
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The “n_cpus” and OMP_NUM_THREADS should be equal or less than the number of CPUs available in the computer.
If these numbers are larger than the actual CPUs number, it can lead to an overload of the machine.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If gp_model.per_atom_par=True and OMP_NUM_THREADS&gt;1, it is equivalent to run with OMP_NUM_THREADS * otf.n_cpus threads
because the MKL calls are nested in the multiprocessing code.</p>
</div>
<p>The current version of FLARE can only support parallel calculations within one compute node.
Interfaces with MPI using multiple nodes are still under development.</p>
<p>If users encounter unusually slow FLARE training and prediction, please file us a Github Issue.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="lammps.html" class="btn btn-neutral float-right" title="Compile LAMMPS with FLARE" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Jonathan Vandermause, Yu Xie, Anders Johansson, Cameron Owen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>