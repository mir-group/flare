

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>After Training &mdash; flare 1.3.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Python Code Documentation" href="../flare/flare.html" />
    <link rel="prev" title="Training a Gaussian Process from an AIMD Run" href="gpfa.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> flare
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="aps_tutorial.html">Introduction to FLARE: Fast Learning of Atomistic Rare Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="prepare_data.html">Prepare your data</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpfa.html">Training a Gaussian Process from an AIMD Run</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">After Training</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Parse-OTF-log-file">Parse OTF log file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Construct-GP-model-from-log-file">Construct GP model from log file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Map-the-GP-force-field-&amp;-Dump-LAMMPS-coefficient-file">Map the GP force field &amp; Dump LAMMPS coefficient file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Run-LAMMPS-with-MGP-pair-style">Run LAMMPS with MGP pair style</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../flare/flare.html">Python Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flare_pp/flare_pp.html">C++ Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../related.html">Applications/Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/contribute.html">How To Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">How to Cite</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">flare</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>After Training</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/after_training.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="After-Training">
<h1>After Training<a class="headerlink" href="#After-Training" title="Permalink to this headline">¶</a></h1>
<p>After the on-the-fly training is complete, we can play with the force field we obtained. We are going to do the following things:</p>
<ol class="arabic simple">
<li>Parse the on-the-fly training trajectory to collect training data</li>
<li>Reconstruct the GP model from the training trajectory</li>
<li>Build up Mapped GP (MGP) for accelerated force field, and save coefficient file for LAMMPS</li>
<li>Use LAMMPS to run fast simulation using MGP pair style</li>
</ol>
<div class="section" id="Parse-OTF-log-file">
<h2>Parse OTF log file<a class="headerlink" href="#Parse-OTF-log-file" title="Permalink to this headline">¶</a></h2>
<p>After the on-the-fly training is complete, we have a log file and can use the <code class="docutils literal notranslate"><span class="pre">otf_parser</span></code> module to parse the trajectory.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">flare</span> <span class="k">import</span> <span class="n">otf_parser</span>

<span class="n">logdir</span> <span class="o">=</span> <span class="s1">&#39;../../../tests/test_files&#39;</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{logdir}</span><span class="s1">/AgI_snippet.out&#39;</span>
<span class="n">hyp_no</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># use the hyperparameters from the 2nd training step</span>
<span class="n">otf_object</span> <span class="o">=</span> <span class="n">otf_parser</span><span class="o">.</span><span class="n">OtfAnalysis</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Construct-GP-model-from-log-file">
<h2>Construct GP model from log file<a class="headerlink" href="#Construct-GP-model-from-log-file" title="Permalink to this headline">¶</a></h2>
<p>We can reconstruct GP model from the parsed log file (the on-the-fly training trajectory). Here we build up the GP model with 2+3 body kernel from the on-the-fly log file.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gp_model</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">make_gp</span><span class="p">(</span><span class="n">hyp_no</span><span class="o">=</span><span class="n">hyp_no</span><span class="p">)</span>
<span class="n">gp_model</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">gp_model</span><span class="o">.</span><span class="n">hyp_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sig2&#39;</span><span class="p">,</span> <span class="s1">&#39;ls2&#39;</span><span class="p">,</span> <span class="s1">&#39;sig3&#39;</span><span class="p">,</span> <span class="s1">&#39;ls3&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">]</span>

<span class="c1"># write model to a binary file</span>
<span class="n">gp_model</span><span class="o">.</span><span class="n">write_model</span><span class="p">(</span><span class="s1">&#39;AgI.gp&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The last step <code class="docutils literal notranslate"><span class="pre">write_model</span></code> is to write this GP model into a binary file, so next time we can directly load the model from the pickle file as</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">flare.gp</span> <span class="k">import</span> <span class="n">GaussianProcess</span>

<span class="n">gp_model</span> <span class="o">=</span> <span class="n">GaussianProcess</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s1">&#39;AgI.gp.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Map-the-GP-force-field-&amp;-Dump-LAMMPS-coefficient-file">
<h2>Map the GP force field &amp; Dump LAMMPS coefficient file<a class="headerlink" href="#Map-the-GP-force-field-&-Dump-LAMMPS-coefficient-file" title="Permalink to this headline">¶</a></h2>
<p>To use the trained force field with accelerated version MGP, or in LAMMPS, we need to build MGP from GP model. Since 2-body and 3-body are both included, we need to set up the number of grid points for 2-body and 3-body in <code class="docutils literal notranslate"><span class="pre">grid_params</span></code>. We build up energy mapping, thus set <code class="docutils literal notranslate"><span class="pre">map_force=False</span></code>. See <a class="reference external" href="https://flare.readthedocs.io/en/latest/tutorials/mgp.html">MGP tutorial</a> for more explanation of the MGP settings.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">flare.mgp</span> <span class="k">import</span> <span class="n">MappedGaussianProcess</span>

<span class="n">grid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;twobody&#39;</span><span class="p">:</span>   <span class="p">{</span><span class="s1">&#39;grid_num&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">64</span><span class="p">]},</span>
               <span class="s1">&#39;threebody&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;grid_num&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]}}</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">gp_model</span><span class="o">.</span><span class="n">training_statistics</span>
<span class="n">lammps_location</span> <span class="o">=</span> <span class="s1">&#39;AgI_Molten&#39;</span>

<span class="n">mgp_model</span> <span class="o">=</span> <span class="n">MappedGaussianProcess</span><span class="p">(</span><span class="n">grid_params</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span>
    <span class="n">var_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lmp_file_name</span><span class="o">=</span><span class="s1">&#39;AgI_Molten&#39;</span><span class="p">,</span> <span class="n">n_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mgp_model</span><span class="o">.</span><span class="n">build_map</span><span class="p">(</span><span class="n">gp_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/yuxie/opt/anaconda3/lib/python3.8/site-packages/flare/mgp/mapxb.py:519: UserWarning: The minimal distance in training data is lower than the current lower bound, will reset lower bound to 2.129780094032889
  warnings.warn(
/Users/yuxie/opt/anaconda3/lib/python3.8/site-packages/flare/mgp/mapxb.py:519: UserWarning: The minimal distance in training data is lower than the current lower bound, will reset lower bound to 2.129780094032889
  warnings.warn(
/Users/yuxie/opt/anaconda3/lib/python3.8/site-packages/flare/mgp/mapxb.py:519: UserWarning: The minimal distance in training data is lower than the current lower bound, will reset lower bound to 2.129780094032889
  warnings.warn(
</pre></div></div>
</div>
<p>The coefficient file for LAMMPS mgp pair_style is automatically saved once the mapping is done. Saved as <code class="docutils literal notranslate"><span class="pre">lmp_file_name</span></code>.</p>
</div>
<div class="section" id="Run-LAMMPS-with-MGP-pair-style">
<h2>Run LAMMPS with MGP pair style<a class="headerlink" href="#Run-LAMMPS-with-MGP-pair-style" title="Permalink to this headline">¶</a></h2>
<p>With the above coefficient file, we can run LAMMPS simulation with the mgp pair style. First download our mgp pair style files, compile your lammps executable with mgp pair style following our <a class="reference external" href="https://flare.readthedocs.io/en/latest/installation/lammps.html">instruction</a> in the <em>Installation</em> section.</p>
<ol class="arabic simple">
<li>One way to use it is running <code class="docutils literal notranslate"><span class="pre">lmp_executable</span> <span class="pre">&lt;</span> <span class="pre">in.lammps</span> <span class="pre">&gt;</span> <span class="pre">log.lammps</span></code> with the executable provided in our repository. When creating the input file, please note to set</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">newton</span> <span class="n">off</span>
<span class="n">pair_style</span> <span class="n">mgp</span>
<span class="n">pair_coeff</span> <span class="o">*</span> <span class="o">*</span> <span class="o">&lt;</span><span class="n">lmp_file_name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">chemical_symbols</span><span class="o">&gt;</span> <span class="n">yes</span><span class="o">/</span><span class="n">no</span> <span class="n">yes</span><span class="o">/</span><span class="n">no</span>
</pre></div>
</div>
<p>An example is using coefficient file <code class="docutils literal notranslate"><span class="pre">AgI_Molten.mgp</span></code> for AgI system, with two-body (the 1st <code class="docutils literal notranslate"><span class="pre">yes</span></code>) together with three-body (the 2nd <code class="docutils literal notranslate"><span class="pre">yes</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pair_coeff</span> <span class="o">*</span> <span class="o">*</span> <span class="n">AgI_Molten</span><span class="o">.</span><span class="n">mgp</span> <span class="n">Ag</span> <span class="n">I</span> <span class="n">yes</span> <span class="n">yes</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Another way is to use the ASE LAMMPS interface</li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">flare.utils.element_coder</span> <span class="k">import</span> <span class="n">_Z_to_mass</span><span class="p">,</span> <span class="n">_element_to_Z</span>
<span class="kn">from</span> <span class="nn">flare.ase.calculator</span> <span class="k">import</span> <span class="n">FLARE_Calculator</span>
<span class="kn">from</span> <span class="nn">ase.calculators.lammpsrun</span> <span class="k">import</span> <span class="n">LAMMPS</span>

<span class="kn">from</span> <span class="nn">ase</span> <span class="k">import</span> <span class="n">Atoms</span>

<span class="c1"># create test structure</span>
<span class="n">species</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">gp_species_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">position_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">forces</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">force_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">otf_cell</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span>
<span class="n">structure</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">symbols</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">otf_cell</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">)</span>

<span class="c1"># get chemical symbols, masses etc.</span>
<span class="n">species</span> <span class="o">=</span> <span class="n">gp_model</span><span class="o">.</span><span class="n">training_statistics</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>
<span class="n">specie_symbol_list</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
<span class="n">masses</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{i}</span><span class="s2"> {_Z_to_mass[_element_to_Z[species[i]]]}&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">))]</span>

<span class="c1"># set up input params</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lmp&#39;</span><span class="p">),</span> <span class="c1"># set up executable for ASE</span>
              <span class="s1">&#39;newton&#39;</span><span class="p">:</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span>
              <span class="s1">&#39;pair_style&#39;</span><span class="p">:</span> <span class="s1">&#39;mgp&#39;</span><span class="p">,</span>
              <span class="s1">&#39;pair_coeff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;* * {lammps_location + &quot;.mgp&quot;} </span><span class="si">{specie_symbol_list}</span><span class="s1"> yes yes&#39;</span><span class="p">],</span>
              <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">masses</span><span class="p">}</span>
<span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">lammps_location</span> <span class="o">+</span> <span class="s2">&quot;.mgp&quot;</span><span class="p">]</span>

<span class="c1"># create ASE calc</span>
<span class="n">lmp_calc</span> <span class="o">=</span> <span class="n">LAMMPS</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;tmp_AgI&#39;</span><span class="p">,</span> <span class="n">keep_tmp_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="s1">&#39;./tmp/&#39;</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">specorder</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>

<span class="n">structure</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">lmp_calc</span>

<span class="c1"># To compute energy, forces and stress</span>
<span class="c1"># energy = structure.get_potential_energy()</span>
<span class="c1"># forces = structure.get_forces()</span>
<span class="c1"># stress = structure.get_stress()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/yuxie/opt/anaconda3/lib/python3.8/site-packages/ase/calculators/lammpsrun.py:191: UserWarning: You are using an old syntax to set &#39;parameters&#39;.
Please use LAMMPSRUN.set().
  warnings.warn(self.legacy_warn_string.format(&#34;parameters&#34;))
</pre></div></div>
</div>
<ol class="arabic simple" start="3">
<li>The third way to run LAMMPS is using our LAMMPS interface, please set the environment variable <code class="docutils literal notranslate"><span class="pre">$lmp</span></code> to the executable.</li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">flare</span> <span class="k">import</span> <span class="n">struc</span>
<span class="kn">from</span> <span class="nn">flare.lammps</span> <span class="k">import</span> <span class="n">lammps_calculator</span>

<span class="c1"># lmp coef file is automatically written now every time MGP is constructed</span>

<span class="c1"># create test structure</span>
<span class="n">species</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">gp_species_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">position_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">forces</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">force_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">otf_cell</span> <span class="o">=</span> <span class="n">otf_object</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span>
<span class="n">structure</span> <span class="o">=</span> <span class="n">struc</span><span class="o">.</span><span class="n">Structure</span><span class="p">(</span><span class="n">otf_cell</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>

<span class="n">atom_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">atom_masses</span> <span class="o">=</span> <span class="p">[</span><span class="mi">108</span><span class="p">,</span> <span class="mi">127</span><span class="p">]</span>
<span class="n">atom_species</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">27</span>

<span class="c1"># create data file</span>
<span class="n">data_file_name</span> <span class="o">=</span> <span class="s1">&#39;tmp.data&#39;</span>
<span class="n">data_text</span> <span class="o">=</span> <span class="n">lammps_calculator</span><span class="o">.</span><span class="n">lammps_dat</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">atom_types</span><span class="p">,</span>
                                         <span class="n">atom_masses</span><span class="p">,</span> <span class="n">atom_species</span><span class="p">)</span>
<span class="n">lammps_calculator</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">data_file_name</span><span class="p">,</span> <span class="n">data_text</span><span class="p">)</span>

<span class="c1"># create lammps input</span>
<span class="n">style_string</span> <span class="o">=</span> <span class="s1">&#39;mgp&#39;</span>
<span class="n">coeff_string</span> <span class="o">=</span> <span class="s1">&#39;* * </span><span class="si">{}</span><span class="s1"> Ag I yes yes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lammps_location</span><span class="p">)</span>
<span class="n">lammps_executable</span> <span class="o">=</span> <span class="s1">&#39;$lmp&#39;</span>
<span class="n">dump_file_name</span> <span class="o">=</span> <span class="s1">&#39;tmp.dump&#39;</span>
<span class="n">input_file_name</span> <span class="o">=</span> <span class="s1">&#39;tmp.in&#39;</span>
<span class="n">output_file_name</span> <span class="o">=</span> <span class="s1">&#39;tmp.out&#39;</span>
<span class="n">input_text</span> <span class="o">=</span> \
    <span class="n">lammps_calculator</span><span class="o">.</span><span class="n">generic_lammps_input</span><span class="p">(</span><span class="n">data_file_name</span><span class="p">,</span> <span class="n">style_string</span><span class="p">,</span>
                                           <span class="n">coeff_string</span><span class="p">,</span> <span class="n">dump_file_name</span><span class="p">)</span>
<span class="n">lammps_calculator</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">,</span> <span class="n">input_text</span><span class="p">)</span>

<span class="c1"># To run lammps and get forces</span>
<span class="c1"># lammps_calculator.run_lammps(lammps_executable, input_file_name,</span>
<span class="c1">#                              output_file_name)</span>

<span class="c1"># lammps_forces = lammps_calculator.lammps_parser(dump_file_name)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../flare/flare.html" class="btn btn-neutral float-right" title="Python Code Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="gpfa.html" class="btn btn-neutral float-left" title="Training a Gaussian Process from an AIMD Run" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Jonathan Vandermause, Yu Xie, Anders Johansson, Cameron Owen

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>